---
import { CollectionEntry, getEntryBySlug } from 'astro:content'
import Page from '~/components/ContentPage.svelte'
import { defaultLang, languages } from '~/i18n/locales'
import Layout from '~/layouts/Content.astro'

const { lang, collection: collectionParam, slug } = Astro.params

if (!lang || (!languages?.[lang] && lang !== defaultLang)) {
	const redirectUrl = [defaultLang, lang, collectionParam, slug]
	return Astro.redirect(`/${redirectUrl.join('/')}/`)
}

const collection = collectionParam as 'docs' | 'download' | 'support'

let page: any = (await getEntryBySlug(
	collection,
	[lang?.toLowerCase(), slug].join('/')
)) as unknown as CollectionEntry<'docs'> | CollectionEntry<'download'> | CollectionEntry<'support'>

if (!page && lang?.toLowerCase() !== defaultLang?.toLowerCase()) {
	page = (await getEntryBySlug(
		collection,
		[defaultLang?.toLowerCase(), slug].join('/')
	)) as unknown as
		| CollectionEntry<'docs'>
		| CollectionEntry<'download'>
		| CollectionEntry<'support'>
}

if (!page) return Astro.redirect(`/${lang}/`)

const { Content, headings, remarkPluginFrontmatter } = await page.render()
---

<Layout
	{collection}
	{headings}
	title={remarkPluginFrontmatter?.title}
	description={remarkPluginFrontmatter?.description}
	jsonLD={remarkPluginFrontmatter?.jsonLD}
>
	<Page title={page.data.title} subtitle={page.data?.subtitle}>
		<Content />
	</Page>
</Layout>
