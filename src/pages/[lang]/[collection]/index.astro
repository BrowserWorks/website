---
import Page from '~/components/ContentPage.svelte'
import { defaultLang, languages, type locales } from '~/i18n/locales'
import Layout from '~/layouts/Content.astro'
import { getCollectionEntries } from '~/lib/collection'

const { collection: collectionParam, lang } = Astro.params

if (!lang || (!languages?.[lang] && lang !== defaultLang)) {
	const redirectUrl = [defaultLang, lang, collectionParam]
	return Astro.redirect(`/${redirectUrl.join('/')}/`)
}

const collection = collectionParam as 'docs' | 'download' | 'support'

let pages = await getCollectionEntries(collection, lang as keyof typeof locales)

if (!pages.length && lang?.toLowerCase() !== defaultLang?.toLowerCase())
	pages = await getCollectionEntries(collection, defaultLang as keyof typeof locales)

if (!pages.length) return Astro.redirect(`/${lang}/`)
---

<Layout
	{collection}
	headings={pages.reduce((acc, curr) => [...acc, ...(curr?.headings || [])], [])}
	jsonLD={pages.map((p) => p?.remarkPluginFrontmatter?.jsonLD)}
>
	{
		pages.map(({ data, Content }) => (
			<Page title={data.title} subtitle={data?.subtitle}>
				<Content />
			</Page>
		))
	}
</Layout>
