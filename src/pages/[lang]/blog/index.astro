---
import Post from '~/components/ContentPost.svelte'
import { defaultLang, languages, type locales } from '~/i18n/locales'
import { useTranslations, type Key } from '~/i18n/utils'
import Layout from '~/layouts/Content.astro'
import { getCollectionEntries } from '~/lib/collection'

const { lang: detectedLang } = Astro.params
const lang = detectedLang as keyof typeof locales

if (!lang || (!languages?.[lang] && lang !== defaultLang)) {
	const redirectUrl = [defaultLang, lang]
	return Astro.redirect(`/${redirectUrl.join('/')}/`)
}

let posts = await getCollectionEntries('blog', lang as keyof typeof locales)

if (!posts.length && lang?.toLowerCase() !== defaultLang?.toLowerCase()) {
	posts = await getCollectionEntries('blog', defaultLang as keyof typeof locales)
}

if (!posts.length) return Astro.redirect(`/${lang}/`)

const t = useTranslations(lang, { useKeyAsFallack: false })
const title = t('blog.meta.title' as Key)
const description = t('blog.meta.description' as Key)
---

<Layout collection="blog" {title} {description}>
	{
		posts.map(({ data, href, formattedDate, Content, remarkPluginFrontmatter }) => (
			<Post
				title={data.title}
				titleLink={href?.replace(defaultLang, lang)}
				author={data.author}
				authorTitle={data.authorTitle}
				authorLink={data.authorUrl}
				authorImageSrc={data.authorImageUrl}
				pubDate={formattedDate}
				readingTime={remarkPluginFrontmatter?.minutesRead}
			>
				<Content />
			</Post>
		))
	}
</Layout>
